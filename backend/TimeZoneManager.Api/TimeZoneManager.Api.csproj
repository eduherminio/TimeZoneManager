<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>netcoreapp3.1</TargetFramework>
    <IsPackable>false</IsPackable>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="Autogenerated\**" />
    <Content Remove="Autogenerated\**" />
    <EmbeddedResource Remove="Autogenerated\**" />
    <None Remove="Autogenerated\**" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.ApplicationInsights" Version="2.12.0" />
    <PackageReference Include="Microsoft.ApplicationInsights.AspNetCore" Version="2.12.0" />
    <PackageReference Include="Microsoft.AspNetCore.Mvc.NewtonsoftJson" Version="3.1.0" />
    <PackageReference Include="NLog" Version="4.6.8" />
    <PackageReference Include="NLog.Web.AspNetCore" Version="4.9.0" />
    <PackageReference Include="NSwag.AspNetCore" Version="13.2.0" />
    <PackageReference Include="NSwag.MSBuild" Version="13.2.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\TimeZoneManager\TimeZoneManager.csproj" />
  </ItemGroup>

  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|AnyCPU'">
    <DocumentationFile>bin\$(Configuration)\$(TargetFramework)\$(AssemblyName).xml</DocumentationFile>
    <NoWarn>1701;1702;1705;1591;</NoWarn>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|AnyCPU'">
    <DocumentationFile>bin\$(Configuration)\$(TargetFramework)\$(AssemblyName).xml</DocumentationFile>
    <NoWarn>1701;1702;1705;1591;</NoWarn>
  </PropertyGroup>

  <Target Name="OpenApiAndClientGeneration" AfterTargets="CreateClientExtensionsFile" DependsOnTargets="CreateClientExtensionsFile" Condition=" '$(Configuration)' == 'Debug'">
    <Message Importance="high" Text="### Generating OpenApi spec and TypeScript clients ###" />
    <Exec Command="$(NSwagExe_Core31) run nswag.json" />
  </Target>

  <ItemGroup>
    <FilePath Include="$(MSBuildThisFileDirectory)\Autogenerated\client.extensions.ts" />
    <Lines Include="import { BaseClient } from '../BaseClient'" />
  </ItemGroup>

  <Target Name="CreateClientExtensionsFile" AfterTargets="Build" Condition=" '$(Configuration)' == 'Debug'">
    <Message Importance="high" Text="### Generating client.extensions.ts file ###" />
    <WriteLinesToFile File="@(FilePath)" Lines="@(Lines)" Overwrite="true" Encoding="Unicode" />
  </Target>

  <!--See https://blogs.msdn.microsoft.com/msbuild/2006/01/02/well-known-limitation-dynamic-items-and-properties-not-emitted-until-target-execution-completes/-->

  <Target Name="CopyInputFilesToOutputDir">
    <CreateProperty Value="">
      <Output TaskParameter="Value" PropertyName="ItemsToCopy" />
    </CreateProperty>
    <CreateItem Include="$(MSBuildProjectDirectory)\Autogenerated\*.ts">
      <Output TaskParameter="Include" ItemName="ItemsToCopy" />
    </CreateItem>
    <Message Importance="high" Text="### Copying generated clients to webclient folder ###" />
    <Copy SourceFiles="@(ItemsToCopy)" DestinationFolder="$(MSBuildProjectDirectory)\\..\\..\\frontend\src\server\autogeneratedclients\" />
  </Target>

  <Target Name="Invoke" AfterTargets="OpenApiAndClientGeneration" DependsOnTargets="OpenApiAndClientGeneration;CreateClientExtensionsFile" Condition=" '$(Configuration)' == 'Debug'">
    <CallTarget Targets="CopyInputFilesToOutputDir" />
  </Target>

</Project>
